{"version":3,"sources":["webpack:///./node_modules/@theia/filesystem/src/browser/download/file-download-command-contribution.ts","webpack:///./node_modules/@theia/filesystem/src/browser/download/file-download-service.ts"],"names":[],"mappings":"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","file":"7.bundle.js","sourcesContent":["/********************************************************************************\n * Copyright (C) 2018 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport { inject, injectable } from 'inversify';\nimport URI from '@theia/core/lib/common/uri';\nimport { isChrome } from '@theia/core/lib/browser/browser';\nimport { environment } from '@theia/application-package/lib/environment';\nimport { SelectionService } from '@theia/core/lib/common/selection-service';\nimport { Command, CommandContribution, CommandRegistry } from '@theia/core/lib/common/command';\nimport { UriAwareCommandHandler } from '@theia/core/lib/common/uri-command-handler';\nimport { FileDownloadService } from './file-download-service';\n\n@injectable()\nexport class FileDownloadCommandContribution implements CommandContribution {\n\n    @inject(FileDownloadService)\n    protected readonly downloadService: FileDownloadService;\n\n    @inject(SelectionService)\n    protected readonly selectionService: SelectionService;\n\n    registerCommands(registry: CommandRegistry): void {\n        registry.registerCommand(\n            FileDownloadCommands.DOWNLOAD,\n            new UriAwareCommandHandler<URI[]>(this.selectionService, {\n                execute: uris => this.executeDownload(uris),\n                isEnabled: uris => this.isDownloadEnabled(uris),\n                isVisible: uris => this.isDownloadVisible(uris),\n            }, { multi: true })\n        );\n        registry.registerCommand(\n            FileDownloadCommands.COPY_DOWNLOAD_LINK,\n            new UriAwareCommandHandler<URI[]>(this.selectionService, {\n                execute: uris => this.executeDownload(uris, { copyLink: true }),\n                isEnabled: uris => isChrome && this.isDownloadEnabled(uris),\n                isVisible: uris => isChrome && this.isDownloadVisible(uris),\n            }, { multi: true })\n        );\n    }\n\n    protected async executeDownload(uris: URI[], options?: { copyLink?: boolean }): Promise<void> {\n        this.downloadService.download(uris, options);\n    }\n\n    protected isDownloadEnabled(uris: URI[]): boolean {\n        return !environment.electron.is() && uris.length > 0 && uris.every(u => u.scheme === 'file');\n    }\n\n    protected isDownloadVisible(uris: URI[]): boolean {\n        return this.isDownloadEnabled(uris);\n    }\n\n}\n\nexport namespace FileDownloadCommands {\n\n    export const DOWNLOAD: Command = {\n        id: 'file.download',\n        category: 'File',\n        label: 'Download'\n    };\n\n    export const COPY_DOWNLOAD_LINK: Command = {\n        id: 'file.copyDownloadLink',\n        category: 'File',\n        label: 'Copy Download Link'\n    };\n\n}\n","/********************************************************************************\n * Copyright (C) 2018 TypeFox and others.\n *\n * This program and the accompanying materials are made available under the\n * terms of the Eclipse Public License v. 2.0 which is available at\n * http://www.eclipse.org/legal/epl-2.0.\n *\n * This Source Code may also be made available under the following Secondary\n * Licenses when the conditions for such availability set forth in the Eclipse\n * Public License v. 2.0 are satisfied: GNU General Public License, version 2\n * with the GNU Classpath Exception which is available at\n * https://www.gnu.org/software/classpath/license.html.\n *\n * SPDX-License-Identifier: EPL-2.0 OR GPL-2.0 WITH Classpath-exception-2.0\n ********************************************************************************/\n\nimport { inject, injectable } from 'inversify';\nimport URI from '@theia/core/lib/common/uri';\nimport { ILogger } from '@theia/core/lib/common/logger';\nimport { Endpoint } from '@theia/core/lib/browser/endpoint';\nimport { FileSystem } from '../../common/filesystem';\nimport { FileDownloadData } from '../../common/download/file-download-data';\nimport { MessageService } from '@theia/core/lib/common/message-service';\nimport { addClipboardListener } from '@theia/core/lib/browser/widgets';\n\n@injectable()\nexport class FileDownloadService {\n\n    protected anchor: HTMLAnchorElement | undefined;\n    protected downloadCounter: number = 0;\n\n    @inject(ILogger)\n    protected readonly logger: ILogger;\n\n    @inject(FileSystem)\n    protected readonly fileSystem: FileSystem;\n\n    @inject(MessageService)\n    protected readonly messageService: MessageService;\n\n    protected handleCopy(event: ClipboardEvent, downloadUrl: string): void {\n        if (downloadUrl && event.clipboardData) {\n            event.clipboardData.setData('text/plain', downloadUrl);\n            event.preventDefault();\n            this.messageService.info('Copied the download link to the clipboard.');\n        }\n    }\n\n    async cancelDownload(id: string): Promise<void> {\n        await fetch(`${this.endpoint()}/download/?id=${id}&cancel=true`);\n    }\n\n    async download(uris: URI[], options?: FileDownloadService.DownloadOptions): Promise<void> {\n        let cancel = false;\n        if (uris.length === 0) {\n            return;\n        }\n        const copyLink = options && options.copyLink ? true : false;\n        try {\n            const [progress, result] = await Promise.all([\n                this.messageService.showProgress({\n                    text: `Preparing download${copyLink ? ' link' : ''}...`, options: { cancelable: true }\n                }, () => { cancel = true; }),\n                // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                new Promise<{ response: Response, jsonResponse: any }>(async resolve => {\n                    const resp = await fetch(this.request(uris));\n                    const jsonResp = await resp.json();\n                    resolve({ response: resp, jsonResponse: jsonResp });\n                })\n            ]);\n            const { response, jsonResponse } = result;\n            if (cancel) {\n                this.cancelDownload(jsonResponse.id);\n                return;\n            }\n            const { status, statusText } = response;\n            if (status === 200) {\n                progress.cancel();\n                const downloadUrl = `${this.endpoint()}/download/?id=${jsonResponse.id}`;\n                if (copyLink) {\n                    if (document.documentElement) {\n                        const toDispose = addClipboardListener(document.documentElement, 'copy', e => {\n                            toDispose.dispose();\n                            this.handleCopy(e, downloadUrl);\n                        });\n                        document.execCommand('copy');\n                    }\n                } else {\n                    this.forceDownload(jsonResponse.id, decodeURIComponent(jsonResponse.name));\n                }\n            } else {\n                throw new Error(`Received unexpected status code: ${status}. [${statusText}]`);\n            }\n        } catch (e) {\n            this.logger.error(`Error occurred when downloading: ${uris.map(u => u.toString(true))}.`, e);\n        }\n    }\n\n    protected async forceDownload(id: string, title: string): Promise<void> {\n        let url: string | undefined;\n        try {\n            if (this.anchor === undefined) {\n                this.anchor = document.createElement('a');\n            }\n            const endpoint = this.endpoint();\n            url = `${endpoint}/download/?id=${id}`;\n            this.anchor.href = url;\n            this.anchor.style.display = 'none';\n            this.anchor.download = title;\n            document.body.appendChild(this.anchor);\n            this.anchor.click();\n        } finally {\n            // make sure anchor is removed from parent\n            if (this.anchor && this.anchor.parentNode) {\n                this.anchor.parentNode.removeChild(this.anchor);\n            }\n            if (url) {\n                URL.revokeObjectURL(url);\n            }\n        }\n    }\n\n    protected request(uris: URI[]): Request {\n        const url = this.url(uris);\n        const init = this.requestInit(uris);\n        return new Request(url, init);\n    }\n\n    protected requestInit(uris: URI[]): RequestInit {\n        if (uris.length === 1) {\n            return {\n                body: undefined,\n                method: 'GET'\n            };\n        }\n        return {\n            method: 'PUT',\n            body: JSON.stringify(this.body(uris)),\n            headers: new Headers({ 'Content-Type': 'application/json' }),\n        };\n    }\n\n    protected body(uris: URI[]): FileDownloadData {\n        return {\n            uris: uris.map(u => u.toString(true))\n        };\n    }\n\n    protected url(uris: URI[]): string {\n        const endpoint = this.endpoint();\n        if (uris.length === 1) {\n            // tslint:disable-next-line:whitespace\n            const [uri,] = uris;\n            return `${endpoint}/?uri=${uri.toString()}`;\n        }\n        return endpoint;\n\n    }\n\n    protected endpoint(): string {\n        const url = this.filesUrl();\n        return url.endsWith('/') ? url.slice(0, -1) : url;\n    }\n\n    protected filesUrl(): string {\n        return new Endpoint({ path: 'files' }).getRestUrl().toString();\n    }\n\n}\n\nexport namespace FileDownloadService {\n    export interface DownloadOptions {\n        /**\n         * `true` if the download link has to be copied to the clipboard. This will not trigger the actual download. Defaults to `false`.\n         */\n        readonly copyLink?: boolean;\n    }\n}\n"],"sourceRoot":""}